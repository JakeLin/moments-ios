language: swift
osx_image: xcode12.2
env:
  global:
    - LC_CTYPE=en_US.UTF-8
    - LANG=en_US.UTF-8
    - WORKSPACE="Moments.xcworkspace"
    - APP_SCHEME="Moments"
  matrix:
    - DESTINATION="platform=iOS Simulator,OS=14.2,name=iPhone 12 Pro Max" APP_SCHEME=${APP_SCHEME}
before_install:
  - bundle install
  - bundle exec pod install
  
jobs:
  include:
    - stage: "Setup"
      name: "Setup"
      script:
        - set -o pipefail
      # - xcodebuild -version
      # - xcodebuild -showsdks

    - stage: "Build"
      name: "Build AppStore app"
      script:
        - ls # will remove  
      # - xcodebuild clean build -workspace "$WORKSPACE" -scheme "$APP_SCHEME" -destination "$DESTINATION" -configuration AppStore | xcpretty;

    - stage: "Test"
      name: "Test app"
      script:
        - ls # will remove
      # - bundle exec fastlane tests
  
    - stage: "Deploy"
      name: "Archive Internal app"
      script:
      - bundle exec fastlane download_profiles
      - bundle exec fastlane archive_internal

after_success:
   - sleep 5 # Workaround for https://github.com/travis-ci/travis-ci/issues/4725